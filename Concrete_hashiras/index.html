<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yin‚ÄìYang Coffee Experience: Pixel Grind V5 (Social & Hot/Cold)</title>
    <!-- Load Tone.js for the 8-bit sound effects (pouring/buzzing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.52/Tone.js"></script>
    <style>
        /* GLOBAL 8-BIT STYLES & PALETTE */
        :root {
            --color-outline: #1A1A1A;
            --color-text: #1A1A1A;
            --color-light-text: #F0F0F0;
            --color-mono: #A0A0A0; 
            --font-8bit: 'Courier New', monospace;
            --pixel-size: 2px;
            --mug-color: #FFFDD0; /* Butter Yellow Empty Cup */
        }

        /* RETRO SCANLINE EFFECT (Visual Polish 1) */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1),
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            z-index: 1000;
            opacity: 0.3;
        }

        /* 8-BIT MANDATE: Ensures blocky scaling */
        * {
            box-sizing: border-box;
            image-rendering: pixelated;
        }

        body {
            font-family: var(--font-8bit);
            color: var(--color-text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        h1, h2, h3 {
            text-shadow: var(--pixel-size) var(--pixel-size) 0 var(--color-outline);
            margin-bottom: 1rem;
            color: var(--color-header-text);
        }

        /* BUTTONS and UI elements - Blocky 8-bit style */
        .button, .game-button, .back-button {
            border: var(--pixel-size) solid var(--color-outline);
            padding: 8px 16px;
            margin: 4px;
            text-transform: uppercase;
            cursor: pointer;
            line-height: 1;
            box-shadow: inset var(--pixel-size) var(--pixel-size) 0 0 rgba(0, 0, 0, 0.4);
            transition: background-color 0.2s, box-shadow 0.2s;
            font-family: var(--font-8bit);
        }

        /* GLITCH HOVER EFFECT (Visual Polish 2) */
        .button:hover, .game-button:hover, .back-button:hover {
            animation: glitch-hover 0.1s steps(2, end) infinite;
        }

        @keyframes glitch-hover {
            0% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, -1px); }
            100% { transform: translate(1px, 1px); }
        }
        
        .button:active, .game-button:active, .back-button:active {
            box-shadow: inset -1px -1px 0 0 rgba(0, 0, 0, 0.4);
        }

        .container {
            max-width: 1024px;
            width: 95%;
            margin: 0 auto;
            padding: 20px 0;
        }

        /* YIN THEME (Soft Pink, High Contrast Text) */
        .yin-theme {
            --color-bg: #F7D6E0; /* Soft Pink Background */
            --color-primary: #D783A0; /* Rose Pink Accent */
            --color-text: #1A1A1A;
            --color-header-text: var(--color-outline);
            background-color: var(--color-bg);
        }
        .yin-theme .button, .yin-theme .game-button, .yin-theme .back-button {
            background-color: var(--color-primary);
            color: var(--color-light-text);
        }
        .yin-theme .box {
            background-color: #FFECEF;
            color: var(--color-text);
            border: var(--pixel-size) solid var(--color-outline);
            box-shadow: var(--pixel-size) var(--pixel-size) 0 0 var(--color-outline);
        }
        
        /* YANG THEME (Reddish Brown, Bold Path) */
        .yang-theme {
            --color-bg: #993300;
            --color-primary: #FFD700;
            --color-text: #F0F0F0;
            --color-header-text: var(--color-light-text);
            background-color: var(--color-bg);
        }
        .yang-theme .button, .yang-theme .game-button, .yang-theme .back-button {
            background-color: var(--color-primary);
            color: var(--color-outline);
        }
        .yang-theme .box {
            background-color: #CC4B00;
            color: var(--color-text);
            border: var(--pixel-size) solid var(--color-outline);
            box-shadow: var(--pixel-size) var(--pixel-size) 0 0 var(--color-outline);
        }

        /* GENERAL STYLES */
        header { padding: 20px; text-align: center; }
        .nav-toggle { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .hero-area { position: relative; width: 100%; height: 300px; overflow: hidden; border-bottom: var(--pixel-size) solid var(--color-outline); margin-bottom: 30px; }
        #coffeeCanvas { display: block; width: 100%; height: 100%; }
        .roast-section { padding: 30px 20px; margin-bottom: 30px; }
        .roast-section h2 { margin-top: 0; }
        .roast-section p, .roast-section ul { font-size: 0.9rem; line-height: 1.6; }
        .roast-section ul { list-style: square; padding-left: 20px; }
        .forum-post { margin-bottom: 15px; padding: 10px; font-size: 0.8rem; border: 1px solid var(--color-mono); }
        .forum-header { color: var(--color-mono); font-size: 0.75rem; margin-bottom: 5px; }
        .social-link { display: inline-block; padding: 10px 15px; background: var(--color-primary); color: var(--color-outline); text-decoration: none; margin: 10px; border: var(--pixel-size) solid var(--color-outline); }
        .social-link:hover { background: var(--color-outline); color: var(--color-primary); }


        /* --- GAME VIEW STYLES --- */
        #gameView, #contactView {
            display: none; /* Hidden by default */
            padding: 30px 10px;
            background-color: var(--color-bg);
            color: var(--color-text);
            min-height: calc(100vh - 40px);
        }
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .game-title { font-size: 1.5rem; }
        .game-status { font-size: 1.1rem; color: var(--color-primary); margin: 20px 0; }
        #mug-preview-area { margin-top: 20px; padding: 15px; border: var(--pixel-size) dashed var(--color-primary); }

        /* MACHINE LAYOUT */
        .brew-lab {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            padding: 20px;
            flex-direction: column;
            align-items: center; /* Center items on small screens */
        }

        .ingredients-list {
            width: 100%;
            max-width: 150px;
            padding: 10px;
            border: var(--pixel-size) solid var(--color-outline);
            background-color: #555;
            flex-shrink: 0;
            margin-bottom: 20px;
        }
        .ingredient {
            width: 100%;
            height: 30px;
            margin: 10px 0;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--color-outline);
            background-color: var(--color-light-text);
            font-size: 0.8rem;
            color: var(--color-outline);
            position: relative;
        }
        .ingredient.used {
            opacity: 0.2;
            cursor: default;
        }

        /* PURE CSS COFFEE MACHINE */
        .coffee-machine {
            position: relative;
            width: 300px;
            height: 250px;
            background-color: #C0C0C0; /* Light Gray Machine Body */
            border: var(--pixel-size) solid var(--color-outline);
            box-shadow: var(--pixel-size) var(--pixel-size) 0 0 var(--color-outline);
            margin: 0;
        }
        /* Hopper is the drop zone (Portafilter/Filter area) */
        .hopper {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 40px;
            background-color: #222; /* Hopper opening */
            border: var(--pixel-size) solid var(--color-outline);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFFF00;
            font-size: 0.7rem;
            padding: 2px;
            z-index: 5;
        }
        .hopper.active {
            border-color: limegreen;
            box-shadow: 0 0 5px 2px limegreen;
        }

        /* MUG VISUAL */
        #final-mug {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 50px;
            border: var(--pixel-size) solid var(--color-outline);
            background-color: var(--mug-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s;
        }
        #final-mug::after {
            content: "";
            position: absolute;
            right: -10px;
            top: 10px;
            width: 10px;
            height: 30px;
            border: var(--pixel-size) solid var(--color-outline);
            border-left: none;
            border-radius: 0 50% 50% 0;
            background-color: inherit;
        }
        
        #coffee-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0%; /* Starts empty */
            background-color: #A0522D; /* Light brown coffee color */
            transition: height 1.5s ease;
        }
        #mug-name { z-index: 10; font-size: 0.6rem; line-height: 1; }
        #mug-logo { font-size: 1.1rem; z-index: 10; }
        
        /* Hot/Cold Visual Indicators */
        #temp-indicator {
            position: absolute;
            top: -20px;
            font-size: 1.5rem;
            line-height: 1;
        }
        
        /* Customization Styles */
        .color-swatch {
            width: 25px;
            height: 25px;
            border: var(--pixel-size) solid var(--color-outline);
            cursor: pointer;
            margin: 5px;
            display: inline-block;
        }
        .temp-option input { margin-right: 5px; }

        /* CSS Grid for larger screens */
        @media (min-width: 768px) {
            .brew-lab {
                flex-direction: row;
                align-items: flex-start;
            }
        }
    </style>
    <!-- Base64 PNGs for Ingredients (Tiny, Pixelated) -->
    <!-- Coffee Bean: Dark Brown (#5C3317) -->
    <img id="beanImg" style="display: none;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFUlEQVR42mP8z8DQwMDAcEwD8jIwAAA//9iQY8oXg00AAAAASUVORK5CYII=">
    <!-- Sugar Cube: White -->
    <img id="sugarImg" style="display: none;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFUlEQVR42mP4z8DQ4EAMwJgBGYwAABjMAAELzE2UAAAAAElpSUAAGf/jKAAAAAElFTkSuQmCC">
    <!-- Milk Drop: Off-White (#F0F8FF) -->
    <img id="milkImg" style="display: none;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAF0lEQVR42mP8z8DQwMDAkFhA4AATKAAAFE4O+oO9V7YAAAAASUVORK5CYII=">
</head>

<body class="yin-theme">

    <!-- MAIN MARKETING VIEW -->
    <div id="mainView" class="container">
        <header>
            <h1>Yin‚ÄìYang Coffee Experience: Pixel Grind</h1>
            <p style="font-size: 0.8rem; color: var(--color-mono);">Choose your caffeine dimension. It's either chill or chaos.</p>
            
            <div class="nav-toggle">
                <button id="yinToggle" class="button">
                    <svg class="icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="vertical-align: middle; margin-right: 5px;"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm0 1.9c3.368 0 6.1 2.732 6.1 6.1s-2.732 6.1-6.1 6.1V8c0-3.368-2.732-6.1-6.1-6.1h6.1zM5.3 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm5.4 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg>
                    Yin: The Soft Path
                </button>
                <button id="yangToggle" class="button">
                    <svg class="icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="vertical-align: middle; margin-right: 5px;"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm0-1.9c-3.368 0-6.1-2.732-6.1-6.1S4.632 1.9 8 1.9v6.1c0 3.368 2.732 6.1 6.1 6.1H8zM10.7 8a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0zM5.3 8a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0z"/></svg>
                    Yang: The Bold Path
                </button>
                <button id="connectToggle" class="button">
                    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="vertical-align: middle; margin-right: 5px;"><path d="M7.5 17.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm-3 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm15-7a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm-3 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18z"/></svg>
                    Connect
                </button>
            </div>
        </header>

        <div class="hero-area">
            <canvas id="coffeeCanvas"></canvas>
            <div class="hero-content">
                <h2 style="color: var(--color-primary); background-color: var(--color-outline); padding: 5px;">Brewing up something ridiculous...</h2>
            </div>
        </div>

        <main>
            <!-- GAME BUTTON -->
            <section class="roast-section box game-container">
                <h2>&#9733; Brew Blast Lab (New!) &#9733;</h2>
                <p style="font-size: 0.85rem; color: var(--color-mono); margin-top: -10px;">Drag, drop, and brew your perfect (or perfectly catastrophic) cup. Compete for the best time!</p>
                <button id="launchGameBtn" class="game-button" style="background-color: limegreen;">Launch Brewing Simulator!</button>
                <div id="highScoreMain" style="margin-top: 10px;">Best Time: N/A</div>
            </section>
            
            <!-- YIN SECTION: Light Roast -->
            <section id="yinSection" class="roast-section yin box">
                <h2>THE EXISTENTIAL CRISIS LITE</h2>
                <p><strong>Roasting as Energy: The Soft Path (Yin)</strong></p>
                <p>Listen up, future caffeine snob. Yin isn't weak; it's *calculated*. We pull the beans out early, right when they're still dreaming about being coffee. This locks in the "acidic brightness"‚Äîbasically, the sour zing that convinces your brain it's awake without the actual intensity. It's high-V, low-damage coffee. Perfect for staring thoughtfully out a window.</p>
                
                <p><strong>Featured Coffee: Mellow Mist Drip</strong> (Tasting Notes: Lemon peel, expensive soap, and the faint memory of a good night's sleep.)</p>
                <ul>
                    <li>**Roast Time:** Short & Sweet (We let it chill).</li>
                    <li>**Flavour Profile:** Smooth, Mild, and just sharp enough to cut through your morning confusion.</li>
                    <li>**Vibe:** Think soft ambient music and a blanket.</li>
                </ul>
            </section>

            <!-- YANG SECTION: Dark Roast -->
            <section id="yangSection" class="roast-section yang box">
                <h2>THE GRIM REAPER'S MORNING BREATH</h2>
                <p><strong>Roasting as Energy: The Bold Path (Yang)</strong></p>
                <p>Yang is where beans go to find their *true* destiny, which is being incinerated. We roast these bad boys until they crackle like popcorn and weep oil. This means the flavor is ALL roast‚Äîbold, smoky, and intense. It‚Äôs basically liquid courage delivered via a tiny black hole. You drink this when your to-do list involves fighting a dragon or dealing with a mandatory team meeting.</p>
                
                <p><strong>Featured Coffee: Turbo Thrust Espresso</strong> (Tasting Notes: Asphalt, existential dread, and the sheer power of three energy drinks condensed into one shot.)</p>
                <ul>
                    <li>**Roast Time:** Long and Aggressive (We don't mess around).</li>
                    <li>**Flavour Profile:** Intense, Bitter, and so strong it registers as a life event.</li>
                    <li>**Vibe:** Think heavy metal and a motivational speaker yelling at you.</li>
                </ul>
            </section>

            <!-- SHOP & REVIEWS SECTION -->
            <section class="roast-section box">
                <h2>Location, Hours, and Roast Reviews</h2>
                
                <p style="text-align: center; margin-bottom: 20px;">
                    <strong style="color: var(--color-primary);">LOCATION:</strong> The Pixelated Corner of Main St. & Arcade Alley (Level 4)<br>
                    <strong style="color: var(--color-primary);">OPENING TIME:</strong> 08:00 AM - 06:00 PM (Monday - Saturday)
                </p>

                <h3 style="color: var(--color-outline); text-shadow: none;">Local Roasting Feedback:</h3>
                
                <div class="forum-post">
                    <div class="forum-header">RoastMaster_2k:</div>
                    <p>"Ordered the Light Roast. It was roasted so subtly, I almost thought they forgot to do anything. Seriously, I spent five minutes checking if the beans were still green. 10/10 for commitment to subtlety."</p>
                </div>
                
                <div class="forum-post">
                    <div class="forum-header">HyperCaff_Dad:</div>
                    <p>"The Dark Roast smells like a campfire and tastes like I just achieved enlightenment. My soul left my body for a moment, and then came back to finish my quarterly report. Perfect energy source."</p>
                </div>
            </section>

        </main>
    </div>

    <!-- GAME LAB VIEW -->
    <div id="gameView">
        <div class="container">
            <div class="game-header">
                <button id="backToMainBtn" class="back-button">‚Üê Back to Menu</button>
                <h2 class="game-title">Brew Blast Lab: Drag & Drop Edition</h2>
                <div id="gameTimeDisplay">Current Time: 0.00s</div>
            </div>

            <div class="box" style="padding: 20px; text-align: center;">
                <div id="gameInstructions" class="game-status">1. Drag the required ingredient into the Hopper.</div>
                <div id="gameMessage" style="color: yellow; min-height: 1em;"></div>

                <div class="brew-lab">
                    
                    <!-- INGREDIENTS AREA -->
                    <div class="ingredients-list">
                        <h3 style="margin-top: 0; color: var(--color-light-text); text-shadow: none; font-size: 0.9rem;">Ingredients (3/3)</h3>
                        <div id="i_bean" class="ingredient" draggable="true" data-type="bean">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFUlEQVR42mP8z8DQwMDAcEwD8jIwAAA//9iQY8oXg00AAAAASUVORK5CYII=" style="width:10px; height:10px; image-rendering:pixelated; margin-right: 5px;" alt="Coffee Bean">
                            Coffee Bean
                        </div>
                        <div id="i_sugar" class="ingredient" draggable="true" data-type="sugar">
                             <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFUlEQVR42mP4z8DQ4EAMwJgBGYwAABjMAAELzE2UAAAAAElpSUAAGf/jKAAAAAElFTkSuQmCC" style="width:10px; height:10px; image-rendering:pixelated; margin-right: 5px;" alt="Sugar Cube">
                            Sugar Cube
                        </div>
                        <div id="i_milk" class="ingredient" draggable="true" data-type="milk">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAF0lEQVR42mP8z8DQwMDAkFhA4AATKAAAFE4O+oO9V7YAAAAASUVORK5CYII=" style="width:10px; height:10px; image-rendering:pixelated; margin-right: 5px;" alt="Milk Drop">
                            Milk Drop
                        </div>

                        <div style="margin-top: 20px; padding: 5px; border-top: 1px solid var(--color-mono); color: var(--color-light-text); font-size: 0.8rem;">
                            <h4 style="margin: 5px 0; text-shadow: none; font-size: 0.9rem; color: var(--color-light-text);">Temp Select</h4>
                            <div class="temp-option" style="text-align: left;">
                                <input type="radio" id="hot" name="temp" value="hot" checked>
                                <label for="hot">Hot</label><br>
                                <input type="radio" id="cold" name="temp" value="cold">
                                <label for="cold">Cold</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- COFFEE MACHINE (CSS Drawing) -->
                    <div class="coffee-machine">
                        <div id="hopper" class="hopper" data-required="bean">Drag Ingredients Here</div>
                        <!-- Brewing Indicator -->
                        <div style="position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 10px; height: 10px; background-color: darkred; border: 1px solid var(--color-outline);" id="brewLight"></div>
                        <div style="position: absolute; top: 80px; left: 50%; transform: translateX(-50%); color: var(--color-light-text); font-size: 0.7rem;">BREWING MODULE</div>
                        
                        <div class="mug-shelf"></div>

                        <div id="final-mug">
                            <div id="temp-indicator"></div>
                            <div id="mug-logo" style="color: black; margin-bottom: 3px;">&#9775;</div>
                            <div id="mug-name"></div>
                            <div id="coffee-fill"></div>
                        </div>

                    </div>
                    
                    <!-- CUSTOMIZATION AND CONTROLS -->
                    <div class="customization-panel" style="width: 100%; max-width: 250px; flex-shrink: 0; padding: 10px;">
                        <h3 style="margin-top: 0; text-shadow: none;">Mug Customization</h3>
                        
                        <label for="userNameInput" style="font-size: 0.8rem;">Your Name Tag:</label>
                        <input type="text" id="userNameInput" maxlength="10" placeholder="PIXEL-USER" value="Player" 
                                style="border: var(--pixel-size) solid var(--color-outline); padding: 5px; margin-bottom: 15px; width: 100%; font-family: var(--font-8bit); text-transform: uppercase;">

                        <h4 style="margin-top: 0; text-shadow: none;">Mug Color</h4>
                        <div id="colorPalette">
                            <span class="color-swatch" data-color="#FFFDD0" style="background-color:#FFFDD0;"></span>
                            <span class="color-swatch" data-color="#ADD8E6" style="background-color:#ADD8E6;"></span>
                            <span class="color-swatch" data-color="#DDA0DD" style="background-color:#DDA0DD;"></span>
                            <span class="color-swatch" data-color="#556B2F" style="background-color:#556B2F;"></span>
                        </div>
                        
                        <button id="brewButton" class="game-button" style="background-color: darkred; margin-top: 20px;" disabled>
                            Start Brewing!
                        </button>
                    </div>

                </div>

                <div id="resultMessage" style="margin-top: 30px; font-size: 1.2rem;"></div>
            </div>
        </div>
    </div>

    <!-- CONTACT VIEW -->
    <div id="contactView">
        <div class="container">
            <div class="game-header">
                <button id="backToMainBtn2" class="back-button">‚Üê Back to Menu</button>
                <h2 class="game-title">Connect With Us: The Digital Roost</h2>
                <div style="width: 150px;"></div> <!-- Spacer -->
            </div>

            <div class="box" style="padding: 30px; text-align: center;">
                <h3 style="font-size: 1.2rem; margin-bottom: 20px;">Follow the Grind!</h3>
                
                <h1 style="font-size: 2.5rem; color: var(--color-primary); margin-top: 0;">@PIXEL_GRIND_CAFFEINE_GURU</h1>

                <p style="margin-top: 30px; font-size: 1rem;">
                    Check our Instagram page for further updates, daily sarcastic wisdom, and questionable latte art.<br>
                    Also, we exist in the digital delivery ether!
                </p>

                <div style="margin-top: 40px;">
                    <a href="https://instagram.com/pixel_grind_caffeine_guru" target="_blank" class="social-link">Instagram Handle</a>
                    <a href="#" target="_blank" class="social-link" style="background-color: #FF6600;">Swiggy</a>
                    <a href="#" target="_blank" class="social-link" style="background-color: #C0C0C0;">Zomato</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === JAVASCRIPT LOGIC ===
        
        // --- CONSTANTS AND STATE ---
        const VIEWS = { MAIN: 'mainView', GAME: 'gameView', CONTACT: 'contactView' };
        const STATES = {
            START: 0,
            PICKING: 1, 
            DROPPING: 2, 
            BREWING: 3,
            POURING: 4,
            FINISHED: 5
        };
        const REQUIRED_INGREDIENTS = ['bean', 'sugar', 'milk']; // ADDED MISSING CONSTANT HERE
        
        // --- DOM ELEMENTS ---
        const mainView = document.getElementById(VIEWS.MAIN);
        const gameView = document.getElementById(VIEWS.GAME);
        const contactView = document.getElementById(VIEWS.CONTACT); // New View
        const launchGameBtn = document.getElementById('launchGameBtn');
        const backToMainBtn = document.getElementById('backToMainBtn');
        const connectToggle = document.getElementById('connectToggle'); // New Nav Button

        const mugElement = document.getElementById('final-mug');
        const coffeeFill = document.getElementById('coffee-fill');
        const hopper = document.getElementById('hopper');
        const brewLight = document.getElementById('brewLight');
        const brewButton = document.getElementById('brewButton');
        const userNameInput = document.getElementById('userNameInput');
        const mugNameDisplay = document.getElementById('mug-name');
        const colorPalette = document.getElementById('colorPalette');
        const gameInstructions = document.getElementById('gameInstructions');
        const gameTimeDisplay = document.getElementById('gameTimeDisplay');
        const resultMessage = document.getElementById('resultMessage');
        const highScoreMain = document.getElementById('highScoreMain');
        const tempIndicator = document.getElementById('temp-indicator');

        // --- GAME VARIABLES ---
        let gameState = STATES.START;
        let ingredientsCollected = new Set();
        let gameActive = false;
        let startTime = 0;
        let bestTime = parseFloat(localStorage.getItem('bestBrewTime')) || Infinity;
        let timerInterval = null;
        let currentMugColor = '#FFFDD0';
        let coffeeTemperature = 'hot'; // Default to hot

        const BEAN_TYPES = {
            bean: { label: "COFFEE BEAN", required: true },
            sugar: { label: "SUGAR CUBE", required: true },
            milk: { label: "MILK DROP", required: true }
        };
        
        // --- GLOBAL UTILITIES (Tone.js & View Management) ---

        function playBuzzSound() {
            if (typeof Tone !== 'undefined') {
                Tone.start();
                const synth = new Tone.Synth({
                    oscillator: { type: "square" },
                    envelope: { attack: 0.05, decay: 0.4, sustain: 0.1, release: 0.5 }
                }).toDestination();
                synth.triggerAttackRelease("C3", 1.5);
                brewLight.style.backgroundColor = 'lime';
                setTimeout(() => brewLight.style.backgroundColor = 'darkred', 100);
            } else {
                console.log("Tone.js not loaded. Cannot play sound.");
            }
        }

        function playBeepPourSound() {
            // High-frequency beeping sound for pouring
            if (typeof Tone !== 'undefined') {
                Tone.start();
                const synth = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 1,
                    envelope: {
                        attack: 0.001,
                        decay: 0.2,
                        sustain: 0.01,
                        release: 0.1,
                        attackCurve: 'exponential'
                    }
                }).toDestination();
                
                // Rapid sequence of beeps to simulate pouring
                const notes = ["C5", "F5", "D5", "G5"];
                let time = Tone.now();
                notes.forEach((note, index) => {
                    synth.triggerAttackRelease(note, "32n", time + index * 0.05);
                });
            } else {
                console.log("Tone.js not loaded. Cannot play sound.");
            }
        }
        
        function updateView(viewId) {
            mainView.style.display = viewId === VIEWS.MAIN ? 'block' : 'none';
            gameView.style.display = viewId === VIEWS.GAME ? 'block' : 'none';
            contactView.style.display = viewId === VIEWS.CONTACT ? 'block' : 'none';
        }

        function updateHighScoreDisplay() {
            const timeString = bestTime === Infinity ? "N/A" : `${bestTime.toFixed(2)}s`;
            highScoreMain.textContent = `Best Time: ${timeString}`;
            if (gameActive) {
                 // Only update the game view display if the game is not active (before it starts)
                 if (gameState === STATES.START) gameTimeDisplay.textContent = `Best Time: ${timeString}`;
            } else {
                 gameTimeDisplay.textContent = `Best Time: ${timeString}`;
            }
        }

        function startTimer() {
            startTime = performance.now();
            timerInterval = setInterval(() => {
                if (gameActive) {
                    const elapsed = (performance.now() - startTime) / 1000;
                    gameTimeDisplay.textContent = `Current Time: ${elapsed.toFixed(2)}s`;
                }
            }, 100);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const endTime = performance.now();
            return (endTime - startTime) / 1000;
        }

        // --- GAME SETUP & FLOW ---

        function setupGame() {
            gameState = STATES.PICKING;
            ingredientsCollected.clear();
            gameActive = true;
            resultMessage.textContent = '';
            brewButton.disabled = true;
            coffeeFill.style.height = '0%';
            mugElement.style.backgroundColor = currentMugColor;
            mugNameDisplay.textContent = userNameInput.value.toUpperCase() || "PLAYER";
            tempIndicator.textContent = '';
            brewLight.style.backgroundColor = 'darkred';

            document.querySelectorAll('.ingredient').forEach(el => {
                el.style.opacity = '1';
                el.draggable = true;
                el.classList.remove('used');
            });
            
            // Set the first required ingredient
            hopper.textContent = `Drag ${BEAN_TYPES.bean.label} Here`;
            hopper.setAttribute('data-required', 'bean');
            hopper.classList.add('active');
            
            gameInstructions.textContent = '1. Drag the COFFEE BEAN into the hopper.';
            startTimer();
        }

        function handleDrop(dataType) {
            if (gameState !== STATES.PICKING) return;
            
            const requiredType = hopper.getAttribute('data-required');

            if (dataType === requiredType) {
                ingredientsCollected.add(dataType);
                
                // Find the next required ingredient
                const nextIndex = ingredientsCollected.size;
                const nextType = REQUIRED_INGREDIENTS[nextIndex]; // This line needed the fix
                
                if (nextType) {
                    hopper.textContent = `Drag ${BEAN_TYPES[nextType].label} Here`;
                    hopper.setAttribute('data-required', nextType);
                    gameInstructions.textContent = `${nextIndex + 1}. Drag the ${BEAN_TYPES[nextType].label}.`;
                } else {
                    // All ingredients collected
                    gameState = STATES.BREWING;
                    hopper.textContent = "Ingredients Ready!";
                    hopper.classList.remove('active');
                    brewButton.disabled = false;
                    gameInstructions.textContent = '4. CLICK "START BREWING!" button.';
                }
            } else {
                gameInstructions.textContent = `WHOOPS! That's not a ${BEAN_TYPES[requiredType].label}. Try again!`;
            }
        }

        function handleBrew() {
            if (gameState !== STATES.BREWING) return;

            gameState = STATES.POURING;
            brewButton.disabled = true;
            coffeeTemperature = document.querySelector('input[name="temp"]:checked').value;
            gameInstructions.textContent = `5. BREWING ${coffeeTemperature.toUpperCase()}... WAIT FOR THE BUZZ!`;
            
            playBuzzSound();

            // Simulate brewing time before pouring
            setTimeout(() => {
                gameState = STATES.FINISHED;
                playBeepPourSound();
                coffeeFill.style.height = '80%';
                
                const timeTaken = stopTimer();
                let message = `Finished! Brew Time: ${timeTaken.toFixed(2)}s.`;

                // Set hot/cold indicator
                if (coffeeTemperature === 'cold') {
                    tempIndicator.textContent = 'üßä'; // Ice cube
                } else {
                    tempIndicator.textContent = '‚ô®Ô∏è'; // Steam/hot
                }


                if (timeTaken < bestTime) {
                    bestTime = timeTaken;
                    localStorage.setItem('bestBrewTime', bestTime);
                    message += " NEW RECORD! Use code 'PIXELPERF' for 50% OFF your next existential crisis!";
                } else {
                    message += " Not bad, but the clock is unimpressed. Try again!";
                }

                resultMessage.textContent = message;
                updateHighScoreDisplay();
                brewButton.textContent = 'RETRY?';
                brewButton.disabled = false;
                brewButton.onclick = setupGame;
                gameInstructions.textContent = '6. Enjoy your custom cup!';

            }, 2500); // 2.5 second brew time
        }
        
        // --- DRAG AND DROP EVENT HANDLERS ---
        
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.getAttribute('data-type'));
            e.target.style.opacity = '0.4'; 
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            const dataType = e.target.getAttribute('data-type');
            
            // If dropped successfully, remove the ingredient element from the list visually
            if (ingredientsCollected.has(dataType)) {
                 e.target.draggable = false;
                 e.target.style.opacity = '0.2';
                 e.target.classList.add('used');
            }
        }

        function handleDragOver(e) {
            e.preventDefault(); 
            if (gameState === STATES.PICKING && hopper.getAttribute('data-required') === e.dataTransfer.types[0]) {
                 hopper.style.backgroundColor = 'green';
            }
        }

        function handleDragLeave(e) {
             hopper.style.backgroundColor = '#222';
        }

        function handleDropEvent(e) {
            e.preventDefault();
            hopper.style.backgroundColor = '#222';
            if (gameState !== STATES.PICKING) return;

            const data = e.dataTransfer.getData('text/plain');
            handleDrop(data);
        }
        
        // --- INITIALIZATION ---
        
        function initEvents() {
            // View navigation
            launchGameBtn.addEventListener('click', () => { updateView(VIEWS.GAME); setupGame(); });
            backToMainBtn.addEventListener('click', () => { 
                updateView(VIEWS.MAIN); 
                if (gameActive) stopTimer();
                gameActive = false; 
                updateHighScoreDisplay();
            });
            document.getElementById('backToMainBtn2').addEventListener('click', () => { updateView(VIEWS.MAIN); });
            connectToggle.addEventListener('click', () => { updateView(VIEWS.CONTACT); });


            // Customization
            userNameInput.addEventListener('input', (e) => {
                mugNameDisplay.textContent = e.target.value.toUpperCase() || "PLAYER";
            });
            mugNameDisplay.textContent = userNameInput.value.toUpperCase();


            colorPalette.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', (e) => {
                    currentMugColor = e.target.getAttribute('data-color');
                    mugElement.style.backgroundColor = currentMugColor;
                });
            });
            
            // Brewing Button
            brewButton.addEventListener('click', handleBrew);

            // Drag and Drop Setup
            document.querySelectorAll('.ingredient').forEach(ing => {
                ing.addEventListener('dragstart', handleDragStart);
                ing.addEventListener('dragend', handleDragEnd);
            });
            hopper.addEventListener('dragover', handleDragOver);
            hopper.addEventListener('dragleave', handleDragLeave);
            hopper.addEventListener('drop', handleDropEvent);
            
            // Apply initial theme styles and start the simulation
            setThem('yin-theme');
            initializeBeansAndStartLoop();
            updateHighScoreDisplay();
            updateView(VIEWS.MAIN);
        }
        
        // --- CANVAS RENDERING (for Main View) ---
        const body = document.body;
        const yinToggle = document.getElementById('yinToggle');
        const yangToggle = document.getElementById('yangToggle');
        const canvas = document.getElementById('coffeeCanvas');
        let currentTheme = 'yin-theme';

        function setThem(theme) {
            currentTheme = theme;
            body.className = theme;
            const computedStyle = getComputedStyle(body);
            const canvasBgColor = computedStyle.getPropertyValue('--color-bg');
            canvas.style.backgroundColor = canvasBgColor;
        }

        yinToggle.addEventListener('click', () => setThem('yin-theme'));
        yangToggle.addEventListener('click', () => setThem('yang-theme'));
        
        // Advanced Gravity (Canvas) Simulation Parameters
        const ctx = canvas.getContext('2d');
        const beans = [];
        const GRAVITY = 0.3;
        const BEAN_COUNT = 30;
        const RESPAWN_THRESHOLD = -50;
        const DRAW_SIZE = 16;
        const BOUNCE_FACTOR = 0.6;
        
        // Pixel Art Coffee Elements (Simplified direct drawing)
        const PIXEL_ELEMENTS = [
            { type: 'bean', size: DRAW_SIZE, colorYin: '#5C3317', colorYang: '#4E342E' }, 
            { type: 'cup', size: DRAW_SIZE + 4, colorYin: '#FFFFFF', colorYang: '#222222' },
            { type: 'steam', size: DRAW_SIZE - 6, colorYin: '#D783A0', colorYang: '#FFD700' }
        ];

        class Bean {
            constructor() {
                this.type = PIXEL_ELEMENTS[Math.floor(Math.random() * PIXEL_ELEMENTS.length)];
                this.physicsSize = this.type.size / 4; 
                this.reset();
            }

            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height * 0.5 + RESPAWN_THRESHOLD;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = Math.random() * 5;
            }

            update() {
                this.vy += GRAVITY;
                this.x += this.vx;
                this.y += this.vy;

                if (this.x + this.physicsSize > canvas.width || this.x < 0) {
                    this.vx *= -1;
                    this.x = Math.max(0, Math.min(this.x, canvas.width - this.physicsSize));
                }

                if (this.y + this.physicsSize > canvas.height) {
                    this.y = canvas.height - this.physicsSize;
                    this.vy *= -BOUNCE_FACTOR;

                    if (Math.abs(this.vy) < 1 || this.type.type === 'steam') { 
                         this.reset();
                    }
                }
                
                if (this.y < RESPAWN_THRESHOLD) {
                    this.reset();
                }
            }

            draw() {
                const drawX = Math.round(this.x);
                const drawY = Math.round(this.y);
                const color = currentTheme === 'yin-theme' ? this.type.colorYin : this.type.colorYang;
                const highlight = currentTheme === 'yin-theme' ? '#EFEFEF' : '#6D4C41';

                ctx.fillStyle = color;
                
                // Draw based on element type for variety (Tempting Pixel Images)
                if (this.type.type === 'bean') {
                    ctx.fillRect(drawX, drawY, DRAW_SIZE, DRAW_SIZE);
                    ctx.fillStyle = highlight;
                    ctx.fillRect(drawX + 6, drawY + 6, 4, 4); 
                } else if (this.type.type === 'cup') {
                    ctx.fillRect(drawX, drawY + 8, DRAW_SIZE, DRAW_SIZE / 2);
                    ctx.fillRect(drawX + DRAW_SIZE, drawY + 12, DRAW_SIZE / 4, DRAW_SIZE / 4); 
                    ctx.fillStyle = highlight;
                    ctx.fillRect(drawX, drawY, DRAW_SIZE, 4); 
                } else if (this.type.type === 'steam') {
                    ctx.globalAlpha = 0.7;
                    ctx.fillStyle = color;
                    ctx.fillRect(drawX, drawY, 8, 8);
                    ctx.fillRect(drawX + 8, drawY + 4, 4, 4);
                    ctx.globalAlpha = 1.0;
                }
            }
        }

        function drawCoffeeMachine() {
            // Draws a large, simplified 8-bit brewing machine outline in the background
            const machineWidth = canvas.width * 0.4;
            const machineHeight = canvas.height * 0.8;
            const machineX = (canvas.width - machineWidth) / 2;
            const machineY = canvas.height - 10 - machineHeight;
            
            const machineColor = '#A0A0A0'; // Gray metal
            const screenColor = '#1A1A1A';
            const dripColor = '#7F4F30'; // Dark coffee reservoir

            // 1. Main body
            ctx.fillStyle = machineColor;
            ctx.fillRect(machineX, machineY, machineWidth, machineHeight);

            // 2. Drip Reservoir (Top)
            ctx.fillStyle = dripColor;
            ctx.fillRect(machineX + 10, machineY + 10, machineWidth - 20, machineHeight / 5);

            // 3. Control Panel/Screen (Middle)
            ctx.fillStyle = screenColor;
            ctx.fillRect(machineX + 10, machineY + machineHeight / 2, machineWidth - 20, machineHeight / 8);

            // 4. Mug placement base (Bottom)
            ctx.fillStyle = machineColor;
            ctx.fillRect(machineX, canvas.height - 30, machineWidth, 20);

            // 5. Mug (The output)
            const mugWidth = 50;
            const mugHeight = 40;
            const mugX = machineX + (machineWidth - mugWidth) / 2;
            const mugY = canvas.height - 70;
            ctx.fillStyle = '#FFFFFF'; // White mug
            ctx.fillRect(mugX, mugY, mugWidth, mugHeight);
            ctx.fillRect(mugX + mugWidth, mugY + 10, 10, 10); // Handle
        }

        function initializeBeansAndStartLoop() {
            for (let i = 0; i < BEAN_COUNT; i++) {
                beans.push(new Bean());
            }
            gameLoop(); 
        }

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            beans.forEach(bean => bean.reset());
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw the background machine/mug
            drawCoffeeMachine();
            
            // Draw an 8-bit style Roaster/Cup bottom (floor)
            ctx.fillStyle = 'rgba(34, 34, 34, 0.7)';
            ctx.fillRect(0, canvas.height - 10, canvas.width, 10);

            beans.forEach(bean => {
                bean.update();
                bean.draw();
            });

            requestAnimationFrame(gameLoop);
        }
        
        // Final initialization call
        window.onload = initEvents;
    </script>
</body>
</html>
